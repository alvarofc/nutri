---
import { getLangFromUrl, useTranslations } from '../../i18n/ui';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const errors = { username: "", email: "", phone: "" };
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const name = data.get("full-name");
    const email = data.get("email");
    const phone = data.get("phone");
    const password = data.get("password");
    if (typeof name !== "string" || name.length < 1) {
      errors.username += t('contact.form.error.name');
    }
    if (typeof email !== "string" || !email.includes("@")) {
      errors.email += t('contact.form.error.email');
    } 
    if (typeof phone !== "string" || phone.length < 6) {
      errors.phone += t('contact.form.error.phone');
    }
    const hasErrors = Object.values(errors).some(msg => msg)
    if (!hasErrors) {
      const response = await fetch("/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, phone, password }),
      }); 
      return Astro.redirect("/");
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---

<section class="py-20 sm:py-28 bg-white">
  <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:max-w-5xl lg:px-8">
    <div class="grid gap-12 lg:grid-cols-2 lg:gap-16 items-start">
      <!-- Left side - Text -->
      <div class="flex flex-col gap-6">
        <span class="inline-flex items-center gap-2 rounded-full bg-brand-blush/50 px-4 py-1.5 text-sm font-medium text-brand-rose w-fit">
          {lang === 'en' ? 'Send a Message' : 'Envía un Mensaje'}
        </span>
        
        <h2 class="font-serif text-3xl sm:text-4xl text-brand-black leading-tight">
          {t('contact.form.title')}
        </h2>
        
        <p class="text-brand-muted text-lg leading-relaxed">
          {t('contact.form.subtitle')}
        </p>
        
        <!-- Trust indicators -->
        <div class="flex flex-col gap-4 mt-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-brand-accent/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brand-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <span class="text-brand-muted">{lang === 'en' ? 'Response within 24 hours' : 'Respuesta en 24 horas'}</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-brand-accent/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brand-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
            </div>
            <span class="text-brand-muted">{lang === 'en' ? 'Your data is safe with me' : 'Tus datos están seguros'}</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-brand-accent/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brand-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
            </div>
            <span class="text-brand-muted">{lang === 'en' ? 'No commitment consultation' : 'Consulta sin compromiso'}</span>
          </div>
        </div>
      </div>
      
      <!-- Right side - Form -->
      <form action="register" method="POST" class="bg-brand-ivory rounded-2xl p-6 sm:p-8 shadow-sm">
        <div class="flex flex-col gap-5">
          <!-- Full name input -->
          <div>
            <label for="full-name" class="block text-sm font-medium text-brand-black mb-2">
              {t('contact.form.name')} <span class="text-brand-rose">*</span>
            </label>
            <input
              type="text"
              name="full-name"
              id="full-name"
              autocomplete="name"
              class="block w-full rounded-xl border-0 bg-white px-4 py-3.5 text-brand-black ring-1 ring-brand-gray/20 placeholder:text-brand-gray transition-all focus:ring-2 focus:ring-brand-accent focus:outline-none hover:ring-brand-accent/50"
              placeholder={t('contact.form.name')}
              required
            />
            {errors.username && <p class="mt-1 text-sm text-brand-rose">{errors.username}</p>}
          </div>

          <!-- Email input -->
          <div>
            <label for="email" class="block text-sm font-medium text-brand-black mb-2">
              {t('contact.form.email')} <span class="text-brand-rose">*</span>
            </label>
            <input
              type="email"
              name="email"
              id="email"
              autocomplete="email"
              class="block w-full rounded-xl border-0 bg-white px-4 py-3.5 text-brand-black ring-1 ring-brand-gray/20 placeholder:text-brand-gray transition-all focus:ring-2 focus:ring-brand-accent focus:outline-none hover:ring-brand-accent/50"
              placeholder={t('contact.form.email')}
              required
            />
          </div>
          
          <!-- Phone input -->
          <div>
            <label for="phone" class="block text-sm font-medium text-brand-black mb-2">
              {t('contact.form.phone')} <span class="text-brand-rose">*</span>
            </label>
            <input
              type="tel"
              name="phone"
              id="phone"
              autocomplete="tel"
              class="block w-full rounded-xl border-0 bg-white px-4 py-3.5 text-brand-black ring-1 ring-brand-gray/20 placeholder:text-brand-gray transition-all focus:ring-2 focus:ring-brand-accent focus:outline-none hover:ring-brand-accent/50"
              placeholder={t('contact.form.phone')}
              pattern="^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$"
              required
            />
          </div>

          <!-- Message textarea -->
          <div>
            <label for="message" class="block text-sm font-medium text-brand-black mb-2">
              {t('contact.form.message')} <span class="text-brand-rose">*</span>
            </label>
            <textarea
              name="message"
              id="message"
              rows="4"
              class="block w-full rounded-xl border-0 bg-white px-4 py-3.5 text-brand-black ring-1 ring-brand-gray/20 placeholder:text-brand-gray transition-all focus:ring-2 focus:ring-brand-accent focus:outline-none hover:ring-brand-accent/50 resize-none"
              placeholder={t('contact.form.message')} 
              required
            ></textarea>
          </div>

          <button
            class="w-full inline-flex items-center justify-center rounded-full bg-brand-accent px-6 py-4 text-base font-medium text-white transition-all hover:bg-brand-accent/90 hover:scale-[1.02] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-accent mt-2"
            type="submit"
          >
            {t('contact.form.submit')}
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
